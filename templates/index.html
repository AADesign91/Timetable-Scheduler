<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Universal Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Simple, clean styling -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
  />
  <style>
    body {
      background: #f1f5f9;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
    }

    .app-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      padding: 20px;
      margin-bottom: 20px;
    }

    .timetable-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .timetable-table th,
    .timetable-table td {
      border: 1px solid #e2e8f0;
      padding: 4px;
      text-align: center;
      min-width: 70px;
    }

    .timetable-table th {
      background: #e0ebff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .time-col {
      background: #f8fafc;
      font-weight: 600;
      position: sticky;
      left: 0;
      z-index: 2;
    }

    .availability-cell {
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
    }

    .availability-cell.selected {
      background: #3b82f6;
      color: #ffffff;
      box-shadow: inset 0 0 0 1px #1d4ed8;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e0f2fe;
      color: #0369a1;
      margin-right: 4px;
    }

    .client-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .client-row:last-child {
      border-bottom: none;
    }

    .btn-main {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
      border-radius: 999px;
      padding: 6px 14px;
    }

    .btn-main:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    .color-tag {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Universal Scheduler</h3>
      <span class="text-muted" style="font-size: 0.85rem;">
        Configure clients & availability, then generate a timetable.
      </span>
    </div>

    <!-- CONFIG / CONTROLS -->
    <div class="row">
      <div class="col-md-4">
        <div class="app-card">
          <h5>Configuration</h5>
          <div class="form-group">
            <label for="useCase">Use case</label>
            <select id="useCase" class="form-control">
              <option value="general">General scheduling</option>
              <option value="learning_centre">Learning centre</option>
              <option value="clinic">Clinic / Therapy</option>
              <option value="coaching">Coaching / Lessons</option>
            </select>
          </div>

          <div class="form-group">
            <label for="scheduleTemplate">Schedule template</label>
            <select id="scheduleTemplate" class="form-control">
              <option value="campus_a">Template A (30-min blocks, 8–4)</option>
              <option value="campus_b">Template B (Mixed 30/40-min blocks)</option>
            </select>
          </div>

          <hr />

          <h5>Add Client</h5>
          <div class="form-group">
            <label for="clientName">Client name</label>
            <input type="text" id="clientName" class="form-control" />
          </div>
          <div class="form-group">
            <label for="sessionsNeeded">Sessions needed per cycle</label>
            <input
              type="number"
              id="sessionsNeeded"
              class="form-control"
              min="1"
              value="1"
            />
          </div>
          <div class="form-group">
            <label for="clientTag">Tag (optional)</label>
            <input
              type="text"
              id="clientTag"
              class="form-control"
              placeholder="e.g., ELL, G3, Adult"
            />
          </div>
          <div class="form-group">
            <label for="spacingRule">Spacing rule</label>
            <select id="spacingRule" class="form-control">
              <option value="none">No spacing requirement</option>
              <option value="once_per_day">At most once per day</option>
            </select>
          </div>
          <button id="addClientBtn" class="btn btn-main btn-block">
            Add client
          </button>
          <small class="text-muted d-block mt-2">
            Select availability on the grid while a client is active.
          </small>
        </div>
      </div>

      <div class="col-md-8">
        <div class="app-card mb-3">
          <h5>Clients</h5>
          <div id="clientsList"></div>
        </div>

        <div class="app-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Availability Grid</h5>
            <button id="generateBtn" class="btn btn-main">
              Generate timetable
            </button>
          </div>
          <small class="text-muted d-block mb-2">
            Click cells to toggle when the active client is available.
          </small>
          <div style="overflow:auto; max-height: 420px;">
            <table class="timetable-table">
              <thead>
                <tr>
                  <th class="time-col">Time / Day</th>
                  <th>Day 1</th>
                  <th>Day 2</th>
                  <th>Day 3</th>
                  <th>Day 4</th>
                  <th>Day 5</th>
                  <th>Day 6</th>
                </tr>
              </thead>
              <tbody id="gridBody">
                <!-- Filled by JS to match back-end time slots -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- STATE -----
    let clients = [];
    let activeClientId = null; // index in clients[]
    let timeSlots = []; // filled from schedule template
    const days = ["Day1", "Day2", "Day3", "Day4", "Day5", "Day6"];

    // ----- HELPERS -----

    function buildTimeSlots(templateName) {
      const slots = [];
      if (templateName === "campus_b") {
        // Matches Python build_time_slots("campus_b")
        slots.push("08:00");
        slots.push("08:30");
        // Then 40-min blocks starting at 9:00
        let hour = 9;
        let minute = 0;
        const endHour = 17;

        function timeToStr(h, m) {
          return (h < 10 ? "0" + h : "" + h) + ":" + (m < 10 ? "0" + m : "" + m);
        }

        function add40(h, m) {
          m += 40;
          if (m >= 60) {
            h += 1;
            m -= 60;
          }
          return [h, m];
        }

        while (hour < endHour) {
          const tStr = timeToStr(hour, minute);
          // Skip recess windows 10:20 and 14:00 (approx)
          if (!(hour === 10 && minute === 20) && !(hour === 14 && minute === 0)) {
            slots.push(tStr);
          }
          [hour, minute] = add40(hour, minute);
        }
      } else {
        // campus_a default – 30-min blocks 8–16, skip 12–13
        for (let h = 8; h < 16; h++) {
          for (let m of [0, 30]) {
            if (h === 12) continue; // skip 12:00–12:30 and 12:30–13:00
            const hh = h < 10 ? "0" + h : "" + h;
            const mm = m === 0 ? "00" : "30";
            slots.push(`${hh}:${mm}`);
          }
        }
      }
      return slots;
    }

    function redrawGrid() {
      const tbody = document.getElementById("gridBody");
      tbody.innerHTML = "";

      timeSlots.forEach((slot) => {
        const tr = document.createElement("tr");

        const timeTd = document.createElement("td");
        timeTd.className = "time-col";
        timeTd.textContent = slot;
        tr.appendChild(timeTd);

        for (let d = 1; d <= 6; d++) {
          const dayKey = "Day" + d;
          const td = document.createElement("td");
          td.className = "availability-cell";
          td.dataset.day = dayKey;
          td.dataset.time = slot;
          td.addEventListener("click", onCellClick);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      // Re-apply currently stored availability
      refreshGridSelectionFromState();
    }

    function refreshGridSelectionFromState() {
      const cells = document.querySelectorAll(".availability-cell");
      cells.forEach((cell) => {
        cell.classList.remove("selected");
      });

      if (activeClientId === null) return;

      const client = clients[activeClientId];
      if (!client || !client.availability) return;

      cells.forEach((cell) => {
        const day = cell.dataset.day;
        const time = cell.dataset.time;
        const timesForDay = client.availability[day] || [];
        if (timesForDay.includes(time)) {
          cell.classList.add("selected");
        }
      });
    }

    function renderClientsList() {
      const listDiv = document.getElementById("clientsList");
      listDiv.innerHTML = "";

      if (clients.length === 0) {
        listDiv.innerHTML =
          '<p class="text-muted mb-0">No clients added yet.</p>';
        return;
      }

      clients.forEach((client, idx) => {
        const row = document.createElement("div");
        row.className = "client-row";

        const left = document.createElement("div");
        const nameEl = document.createElement("strong");
        nameEl.textContent = client.name || "Unnamed";

        const tagEl = document.createElement("span");
        if (client.tag) {
          tagEl.className = "pill";
          tagEl.textContent = client.tag;
        }

        const metaEl = document.createElement("div");
        metaEl.style.fontSize = "0.75rem";
        metaEl.className = "text-muted";
        metaEl.textContent =
          client.sessions_needed +
          " session" +
          (client.sessions_needed !== 1 ? "s" : "") +
          " • " +
          (client.spacing_rule === "once_per_day"
            ? "Max 1/day"
            : "No spacing rule");

        left.appendChild(nameEl);
        if (client.tag) left.appendChild(tagEl);
        left.appendChild(document.createElement("br"));
        left.appendChild(metaEl);

        const right = document.createElement("div");

        const selectBtn = document.createElement("button");
        selectBtn.className =
          "btn btn-sm " +
          (activeClientId === idx ? "btn-main" : "btn-outline-secondary");
        selectBtn.textContent = activeClientId === idx ? "Active" : "Select";
        selectBtn.style.marginRight = "4px";
        selectBtn.addEventListener("click", () => {
          if (activeClientId === idx) {
            // Deselect
            activeClientId = null;
          } else {
            activeClientId = idx;
          }
          renderClientsList();
          refreshGridSelectionFromState();
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-sm btn-outline-danger";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => {
          clients.splice(idx, 1);
          if (activeClientId === idx) {
            activeClientId = null;
          } else if (activeClientId > idx) {
            activeClientId -= 1;
          }
          renderClientsList();
          refreshGridSelectionFromState();
        });

        right.appendChild(selectBtn);
        right.appendChild(deleteBtn);

        row.appendChild(left);
        row.appendChild(right);

        listDiv.appendChild(row);
      });
    }

    function onCellClick(e) {
      if (activeClientId === null) {
        alert("Please select a client first.");
        return;
      }
      const cell = e.currentTarget;
      const day = cell.dataset.day;
      const time = cell.dataset.time;

      const client = clients[activeClientId];
      if (!client.availability[day]) {
        client.availability[day] = [];
      }

      const idx = client.availability[day].indexOf(time);
      if (idx === -1) {
        client.availability[day].push(time);
        cell.classList.add("selected");
      } else {
        client.availability[day].splice(idx, 1);
        cell.classList.remove("selected");
      }
    }

    // ----- EVENT HANDLERS -----

    document.getElementById("addClientBtn").addEventListener("click", () => {
      const name = document.getElementById("clientName").value.trim();
      const sessionsNeeded = parseInt(
        document.getElementById("sessionsNeeded").value,
        10
      );
      const tag = document.getElementById("clientTag").value.trim();
      const spacingRule = document.getElementById("spacingRule").value;

      if (!name) {
        alert("Please enter a client name.");
        return;
      }
      if (!sessionsNeeded || sessionsNeeded < 1) {
        alert("Please enter how many sessions they need.");
        return;
      }

      clients.push({
        name: name,
        sessions_needed: sessionsNeeded,
        tag: tag || "",
        spacing_rule: spacingRule,
        availability: {},
      });

      // reset form
      document.getElementById("clientName").value = "";
      document.getElementById("sessionsNeeded").value = "1";
      document.getElementById("clientTag").value = "";
      document.getElementById("spacingRule").value = "none";

      // make this new client active
      activeClientId = clients.length - 1;
      renderClientsList();
      refreshGridSelectionFromState();
    });

    document.getElementById("scheduleTemplate").addEventListener("change", () => {
      const tmpl = document.getElementById("scheduleTemplate").value;
      timeSlots = buildTimeSlots(tmpl);
      redrawGrid();
    });

    document.getElementById("generateBtn").addEventListener("click", () => {
      if (clients.length === 0) {
        alert("Please add at least one client.");
        return;
      }

      // Build payload for backend
      const payload = {
        use_case: document.getElementById("useCase").value,
        schedule_template: document.getElementById("scheduleTemplate").value,
        clients: clients,
        // groups: [] // reserved for future
      };

      fetch("/generate_timetable", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) => {
          if (!res.ok) throw new Error("Error generating timetable");
          return res.text();
        })
        .then((html) => {
          // Replace page with returned HTML
          document.open();
          document.write(html);
          document.close();
        })
        .catch((err) => {
          console.error(err);
          alert("Error generating timetable.");
        });
    });

    // ----- INIT -----
    (function init() {
      const tmpl = document.getElementById("scheduleTemplate").value;
      timeSlots = buildTimeSlots(tmpl);
      redrawGrid();
      renderClientsList();
    })();
  </script>
</body>
</html>
